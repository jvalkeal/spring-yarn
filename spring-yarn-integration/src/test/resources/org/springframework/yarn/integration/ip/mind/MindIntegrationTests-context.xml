<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:int="http://www.springframework.org/schema/integration"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:ip="http://www.springframework.org/schema/integration/ip"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.springframework.org/schema/integration
            http://www.springframework.org/schema/integration/spring-integration.xsd
            http://www.springframework.org/schema/integration/ip
            http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd">

    <bean id="tcpIpUtils" class="org.springframework.integration.test.util.SocketUtils" />
    
    <bean id="serializer" class="org.springframework.yarn.integration.ip.mind.MindRpcSerializer" />
    <bean id="deserializer" class="org.springframework.yarn.integration.ip.mind.MindRpcSerializer" />

    <bean id="socketSupport" class="org.springframework.yarn.integration.support.DefaultTcpSocketSupport" />
    
    <ip:tcp-connection-factory id="serverConnectionFactory"
        type="server"
        port="#{tcpIpUtils.findAvailableServerSocket(7400)}"
        socket-support="socketSupport"
        serializer="serializer"        
        deserializer="deserializer"/>

    <ip:tcp-connection-factory id="clientConnectionFactory"
        type="client"
        host="localhost"
        port="#{serverConnectionFactory.port}"
        serializer="serializer"        
        deserializer="deserializer"/>
    
    <ip:tcp-inbound-gateway id="inboundGateway"
        connection-factory="serverConnectionFactory"
        request-channel="serverChannel" />

    <ip:tcp-outbound-gateway id="outboundGateway"
        connection-factory="clientConnectionFactory"
        request-channel="clientRequestChannel"
        reply-channel="clientResponseChannel" />
    
    <int:channel id="serverChannel" />
    <int:channel id="clientRequestChannel" />
    <int:channel id="clientResponseChannel" >
        <int:queue />
    </int:channel>
    
    <int:service-activator id="serviceActivator" 
        input-channel="serverChannel"
        ref="mindAppmasterService"
        method="handleMessage" />

    <!-- 
    <bean id="loginService" class="org.springframework.yarn.integration.ip.mind.LoginService" />
     -->
    
    <bean id="mindAppmasterService" class="org.springframework.yarn.integration.ip.mind.MindAppmasterService" >
        <property name="socketSupport" ref="socketSupport"/>
    </bean>
    
    <bean id="mindAppmasterServiceClient" class="org.springframework.yarn.integration.ip.mind.MindAppmasterServiceClient">
        <property name="requestChannel" ref="clientRequestChannel"/>
        <property name="responseChannel" ref="clientResponseChannel"/>
    </bean>
    
    
</beans>
